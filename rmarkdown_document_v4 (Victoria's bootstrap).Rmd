---
title: "STAT_535_Project"
author: "Sayak Chatterjee"
date: "2025-12-06"
output: pdf_document
---

# Data scraping for the Asthama rates for different years across the different states in the US

```{r}
urls <- c(
  "2000" = "https://www.cdc.gov/asthma/brfss/00/current/tableC1.htm",
  "2001" = "https://www.cdc.gov/asthma/brfss/01/current/tableC1.htm",
  "2002" = "https://www.cdc.gov/asthma/brfss/02/current/tableC1.htm",
  "2003" = "https://www.cdc.gov/asthma/brfss/03/current/tableC1.htm",
  "2004" = "https://www.cdc.gov/asthma/brfss/04/current/tableC1.htm",
  "2005" = "https://www.cdc.gov/asthma/brfss/05/current/tableC1.htm",
  "2006" = "https://www.cdc.gov/asthma/brfss/06/current/tableC1.htm",
  "2007" = "https://www.cdc.gov/asthma/brfss/07/current/tableC1.htm",
  "2008" = "https://www.cdc.gov/asthma/brfss/08/current/tableC1.htm",
  "2009" = "https://www.cdc.gov/asthma/brfss/09/current/tableC1.htm",
  "2010" = "https://www.cdc.gov/asthma/brfss/2010/current/tableC1.htm",
  "2011" = "https://www.cdc.gov/asthma/brfss/2011/tableC1.htm",
  "2012" = "https://www.cdc.gov/asthma/brfss/2012/tableC1.htm",
  "2013" = "https://www.cdc.gov/asthma/brfss/2013/tableC1.htm",
  "2014" = "https://www.cdc.gov/asthma/brfss/2014/tableC1.htm",
  "2015" = "https://www.cdc.gov/asthma/brfss/2015/tableC1.htm",
  "2016" = "https://www.cdc.gov/asthma/brfss/2016/tableC1.htm",
  "2017" = "https://www.cdc.gov/asthma/brfss/2017/tableC1.htm",
  "2018" = "https://www.cdc.gov/asthma/brfss/2018/tableC1.html",
  "2019" = "https://www.cdc.gov/asthma/brfss/2019/tableC1.html",
  "2020" = "https://www.cdc.gov/asthma/brfss/2020/tableC1.html"
)

```


```{r}
library(rvest)
library(dplyr)
library(stringr)
library(purrr)

scrape_c1 <- function(url, year) {
  message("Scraping ", year, " from ", url)
  
  page <- try(read_html(url), silent = TRUE)
  if (inherits(page, "try-error")) {
    warning("Failed to load ", url)
    return(NULL)
  }
  
  # Extract all HTML tables
  tables <- page %>% html_table(fill = TRUE)
  if (length(tables) == 0) {
    warning("No tables found for ", year)
    return(NULL)
  }
  
  # Pick the table that contains "State" in headers
  idx <- which.max(
    sapply(tables, function(x) any(grepl("State", names(x), ignore.case = TRUE)))
  )
  
  df <- tables[[idx]]
  names(df) <- tolower(names(df))
  
  # Identify relevant columns
  state_col <- grep("state", names(df), value = TRUE)[1]
  prev_col  <- grep("prev|percent", names(df), value = TRUE)[1]
  se_col    <- grep("se|error", names(df), value = TRUE)[1]
  
  if (is.na(state_col) || is.na(prev_col) || is.na(se_col)) {
    warning("Missing columns in ", year)
    return(NULL)
  }
  
  # Clean the table
  df_clean <- df %>%
    select(state = !!state_col, prevalence = !!prev_col, se = !!se_col) %>%
    mutate(
      year = as.numeric(year),
      state = trimws(state),
      prevalence = as.numeric(gsub("[^0-9.]", "", prevalence)),
      se = as.numeric(gsub("[^0-9.]", "", se))
    ) %>%
    filter(!is.na(prevalence), !grepl("total", state, ignore.case = TRUE))
  
  return(df_clean)
}

all_data <- map2_df(urls, names(urls), scrape_c1)

unique(all_data$year)

```


```{r}
library(ggplot2)

plot_asthma_year <- function(data, year_to_plot) {
  
  df_year <- data %>%
    filter(year == year_to_plot,
           !grepl("total", state, ignore.case = TRUE)) %>%
    mutate(state = trimws(state)) %>%
    arrange(prevalence)
  
  ggplot(df_year, aes(x = reorder(state, prevalence), y = prevalence)) +
    geom_col(fill = "steelblue", alpha = 0.85) +
    geom_errorbar(aes(ymin = prevalence - se,
                      ymax = prevalence + se),
                  width = 0.3, color = "black") +
    labs(
      title = paste("Asthma Prevalence by State in", year_to_plot),
      x = "State",
      y = "Asthma Prevalence (%)"
    ) +
    theme_minimal(base_size = 14) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
}

```

```{r}
plot_asthma_year(all_data, 2000)
plot_asthma_year(all_data, 2001)
plot_asthma_year(all_data, 2002)
plot_asthma_year(all_data, 2003)
plot_asthma_year(all_data, 2004)
plot_asthma_year(all_data, 2005)
plot_asthma_year(all_data, 2006)
plot_asthma_year(all_data, 2007)
plot_asthma_year(all_data, 2008)
plot_asthma_year(all_data, 2009)
plot_asthma_year(all_data, 2010)
plot_asthma_year(all_data, 2011)
plot_asthma_year(all_data, 2012)
plot_asthma_year(all_data, 2013)
plot_asthma_year(all_data, 2014)
plot_asthma_year(all_data, 2015)
plot_asthma_year(all_data, 2016)
plot_asthma_year(all_data, 2017)
plot_asthma_year(all_data, 2018)
plot_asthma_year(all_data, 2019)
plot_asthma_year(all_data, 2020)

```



# Data scraping for the Air pollutants (average) 2000-2024 (AQI)

```{r}
library(readr)
library(janitor)
library(lubridate)

# Load CSV file
pol_data <- read_csv("data/pollution_2000_2023.csv") %>% 
  clean_names()

# Convert date column
aqi <- pol_data %>%
  mutate(date = suppressWarnings(as.Date(date, format = "%d/%m/%y")),
         year = year(date))

# Identify AQI columns that exist
aqi_columns <- c("o3_aqi", "co_aqi", "so2_aqi", "no2_aqi")
aqi_columns <- aqi_columns[aqi_columns %in% names(aqi)]

# Compute average AQI by state and year
aqi_state_year <- aqi %>%
  group_by(state, year) %>%
  summarise(
    across(
      all_of(aqi_columns), 
      ~ mean(.x, na.rm = TRUE)
    )
  ) %>%
  ungroup()

aqi_state_year
```

# Data scraping for the Air pollutants (average) 2000-2024 (Mean)

```{r}
# Convert date column (your format is like "01/01/00")
poll <- pol_data %>%
  mutate(
    date = suppressWarnings(as.Date(date, format = "%m/%d/%y")),
    year = year(date)
  )

# Identify pollutant MEAN columns (NOT AQI)
pollutant_mean_cols <- c(
  "o3_mean",
  "co_mean",
  "so2_mean",
  "no2_mean",
  "pm25_mean",
  "pm10_mean"
)

# Only keep columns that actually exist in the file
pollutant_mean_cols <- pollutant_mean_cols[pollutant_mean_cols %in% names(poll)]

# Compute state-year mean pollutant concentrations
pollution_state_year <- poll %>%
  group_by(state, year) %>%
  summarise(
    across(
      all_of(pollutant_mean_cols),
      ~ mean(.x, na.rm = TRUE)
    ),
    .groups = "drop"
  )

pollution_state_year
```


# Plotting for the pollutant means

```{r}
plot_pollutant_by_state <- function(data, year_to_plot, pollutant_col) {
  
  df_year <- data %>%
    filter(year == year_to_plot) %>%
    select(state, year, all_of(pollutant_col)) %>%
    arrange(.data[[pollutant_col]])
  
  ggplot(df_year, aes(x = reorder(state, .data[[pollutant_col]]), 
                      y = .data[[pollutant_col]])) +
    geom_col(fill = "steelblue", alpha = 0.85) +
    labs(
      title = paste("State-wise", pollutant_col, "in", year_to_plot),
      x = "State",
      y = paste("Mean", pollutant_col)
    ) +
    theme_minimal(base_size = 14) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
}

plot_pollutant_by_state(pollution_state_year, 2000, "o3_mean")
plot_pollutant_by_state(pollution_state_year, 2000, "no2_mean")
plot_pollutant_by_state(pollution_state_year, 2000, "co_mean")
plot_pollutant_by_state(pollution_state_year, 2000, "so2_mean")

```

# Plotting for the pollutant AQIs

```{r}
plot_aqi_by_state <- function(data, year_to_plot, aqi_col) {
  
  df_year <- data %>%
    filter(year == year_to_plot) %>%
    select(state, year, all_of(aqi_col)) %>%
    arrange(.data[[aqi_col]])
  
  ggplot(df_year, aes(x = reorder(state, .data[[aqi_col]]), 
                      y = .data[[aqi_col]])) +
    geom_col(fill = "tomato", alpha = 0.85) +
    labs(
      title = paste("State-wise", aqi_col, "AQI in", year_to_plot),
      x = "State",
      y = paste("AQI:", aqi_col)
    ) +
    theme_minimal(base_size = 14) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
}

plot_aqi_by_state(aqi_state_year, 2000, "o3_aqi")
plot_aqi_by_state(aqi_state_year, 2000, "co_aqi")
plot_aqi_by_state(aqi_state_year, 2000, "so2_aqi")
plot_aqi_by_state(aqi_state_year, 2000, "no2_aqi")

```

# Correlation between AQI and the mean value of a particular pollutant

```{r}
plot_correlation_aqi_pollutant <- function(aqi_data, pollutant_data, 
                                           year_to_plot, 
                                           aqi_col, pollutant_col) {
  
  # Merge AQI + pollutant dataset by state + year
  df <- aqi_data %>%
    inner_join(pollutant_data, by = c("state", "year")) %>%
    filter(year == year_to_plot) %>%
    select(state, year, all_of(aqi_col), all_of(pollutant_col))
  
  # Compute correlation
  corr_value <- round(cor(df[[aqi_col]], df[[pollutant_col]], use = "complete.obs"), 3)
  
  # Plot
  ggplot(df, aes(x = .data[[pollutant_col]], y = .data[[aqi_col]])) +
    geom_point(color = "steelblue", size = 3) +
    geom_smooth(method = "lm", se = TRUE, color = "#A8455D") +
    labs(
      title = paste("Correlation Between", pollutant_col, "and", aqi_col, "in", year_to_plot),
      subtitle = paste("Pearson r =", corr_value),
      x = paste("Mean", pollutant_col),
      y = paste("AQI:", aqi_col)
    ) +
    theme_minimal(base_size = 14)
}

plot_correlation_aqi_pollutant(aqi_state_year, pollution_state_year,
                               2018, "no2_aqi", "no2_mean")

plot_correlation_aqi_pollutant(aqi_state_year, pollution_state_year,
                               2010, "so2_aqi", "so2_mean")
plot_correlation_aqi_pollutant(aqi_state_year, pollution_state_year,
                               2000, "so2_aqi", "so2_mean")
plot_correlation_aqi_pollutant(aqi_state_year, pollution_state_year,
                               2005, "co_aqi", "co_mean")
```




# Creating the final dataset

```{r}
state_map <- data.frame(
  state_abb = state.abb,
  state_name = state.name,
  stringsAsFactors = FALSE
)

# Add DC manually (not included in state.name/state.abb defaults)
state_map <- rbind(
  state_map,
  data.frame(state_abb = "DC", state_name = "District Of Columbia", stringsAsFactors = FALSE)
)

asthma_state_year_fixed <- all_data %>%
  mutate(state = trimws(state)) %>%
  left_join(state_map, by = c("state" = "state_abb")) %>%
  mutate(state = state_name) %>%
  select(-state_name)

unique(asthma_state_year_fixed$state)[1:10]

length(intersect(unique(asthma_state_year_fixed$state),
                 unique(aqi_state_year$state)))

full_data <- asthma_state_year_fixed %>%
  inner_join(aqi_state_year, by = c("state", "year")) %>%
  inner_join(pollution_state_year, by = c("state", "year"))

glimpse(full_data)
nrow(full_data)

```

```{r}
glimpse(full_data)
nrow(full_data)
unique(full_data$state)[1:20]
range(full_data$year)

```



# Linear Regression
#multi-pollutant model
```{r}
library(car)

model_pollution <- lm(
  prevalence ~  o3_mean + no2_mean + so2_mean + co_mean,
  data = full_data
)

summary(model_pollution)

#checking for multi-collinearity among the pollutants
vif(model_pollution)

```

# Fitting single-pollutant models
```{r}
summary(lm(prevalence ~ o3_mean, data = full_data))
summary(lm(prevalence ~ co_mean, data = full_data))
summary(lm(prevalence ~ so2_mean, data = full_data))
summary(lm(prevalence ~ no2_mean, data = full_data))

```


# pollution trends vs asthma trends

Compute Pollution and Asthma Trends for Each State

We will do this using per-state linear trends:

For each state, fit:

Pollutant (t) = $\alpha$ + $\beta$t
Asthma (t) = $\gamma$ + $\delta$t

Then compare the slopes $\beta$ and $\delta$ across states.

Which asks:
In states where pollution declined faster, did asthma prevalence also decline faster?

```{r}
library(dplyr)
library(purrr)
library(broom)

o3_slopes <- full_data %>%
  group_by(state) %>%
  do(tidy(lm(o3_mean ~ year, data = .))) %>%
  filter(term == "year") %>%
  select(state, o3_slope = estimate)

no2_slopes <- full_data %>%
  group_by(state) %>%
  do(tidy(lm(no2_mean ~ year, data = .))) %>%
  filter(term == "year") %>%
  select(state, no2_slope = estimate)

so2_slopes <- full_data %>%
  group_by(state) %>%
  do(tidy(lm(so2_mean ~ year, data = .))) %>%
  filter(term == "year") %>%
  select(state, so2_slope = estimate)

co_slopes <- full_data %>%
  group_by(state) %>%
  do(tidy(lm(co_mean ~ year, data = .))) %>%
  filter(term == "year") %>%
  select(state, co_slope = estimate)

```

```{r}
asthma_slopes <- full_data %>%
  group_by(state) %>%
  do(tidy(lm(prevalence ~ year, data = .))) %>%
  filter(term == "year") %>%
  select(state, asthma_slope = estimate)

```

```{r}
trend_data <- asthma_slopes %>%
  left_join(o3_slopes, by = "state") %>%
  left_join(no2_slopes, by = "state") %>%
  left_join(so2_slopes, by = "state") %>%
  left_join(co_slopes, by = "state")

trend_data
```

#Do states with faster pollution declines experience faster asthma declines?

```{r}
summary(lm(asthma_slope ~ o3_slope, data = trend_data))
summary(lm(asthma_slope ~ no2_slope, data = trend_data))
summary(lm(asthma_slope ~ so2_slope, data = trend_data))
summary(lm(asthma_slope ~ co_slope, data = trend_data))


ggplot(trend_data, aes(x = o3_slope, y = asthma_slope)) +
  geom_point(size = 3, color = "steelblue") +
  geom_smooth(method = "lm", se = TRUE, color = "#A8455D") +
  labs(
    title = "Do O3 Trends Predict Asthma Trends Over 2000–2020?",
    x = "Annual O3 Trend (slope)",
    y = "Annual Asthma Trend (slope)"
  ) +
  theme_minimal(base_size = 14)

ggplot(trend_data, aes(x = no2_slope, y = asthma_slope)) +
  geom_point(size = 3, color = "steelblue") +
  geom_smooth(method = "lm", se = TRUE, color = "#A8455D") +
  labs(
    title = "Do NO2 Trends Predict Asthma Trends Over 2000–2020?",
    x = "Annual NO2 Trend (slope)",
    y = "Annual Asthma Trend (slope)"
  ) +
  theme_minimal(base_size = 14)

ggplot(trend_data, aes(x = so2_slope, y = asthma_slope)) +
  geom_point(size = 3, color = "steelblue") +
  geom_smooth(method = "lm", se = TRUE, color = "#A8455D") +
  labs(
    title = "Do SO2 Trends Predict Asthma Trends Over 2000–2020?",
    x = "Annual SO2 Trend (slope)",
    y = "Annual Asthma Trend (slope)"
  ) +
  theme_minimal(base_size = 14)

ggplot(trend_data, aes(x = co_slope, y = asthma_slope)) +
  geom_point(size = 3, color = "steelblue") +
  geom_smooth(method = "lm", se = TRUE, color = "#A8455D") +
  labs(
    title = "Do CO Trends Predict Asthma Trends Over 2000–2020?",
    x = "Annual CO Trend (slope)",
    y = "Annual Asthma Trend (slope)"
  ) +
  theme_minimal(base_size = 14)
```


# Selecting 10 most polluted states

```{r}
library(dplyr)

# List of pollutant mean columns (modify as needed)
pollutants <- c("o3_mean", "no2_mean", "so2_mean", "co_mean")

# Compute average pollution across 2000–2020 for each state
state_pollution <- full_data %>%
  group_by(state) %>%
  summarise(across(all_of(pollutants), mean, na.rm = TRUE)) %>%
  ungroup()

# Create a combined pollution index (average of standardized pollutants)
state_pollution <- state_pollution %>%
  mutate(pollution_index = rowMeans(scale(across(all_of(pollutants)))))

```

```{r}
top_states <- state_pollution %>%
  arrange(desc(pollution_index)) %>%
  slice(1:10) %>%
  pull(state)

top_states

highpoll_data <- full_data %>%
  filter(state %in% top_states)

```

```{r}
library(plm)

model_highpoll <- plm(
  prevalence ~ o3_mean + no2_mean + so2_mean + co_mean,
  data = highpoll_data,
  index = c("state","year"),
  model = "within"
)

summary(model_highpoll)

```


```{r}
library(ggplot2)
library(dplyr)
library(tidyr)

# convert dataset to long format for easy plotting
plot_data <- highpoll_data %>%
  select(state, year, prevalence, o3_mean, no2_mean, so2_mean, co_mean) %>%
  pivot_longer(cols = c(prevalence, o3_mean, no2_mean, so2_mean, co_mean),
               names_to = "variable", values_to = "value")

# facet plot for trends
ggplot(plot_data, aes(x = year, y = value, color = variable)) +
  geom_line(size = 1.1) +
  facet_wrap(~ state, scales = "free_y") +
  theme_bw() +
  labs(
    title = "Asthma & Pollution Trends in High-Pollution States",
    x = "Year",
    y = "Value",
    color = "Variable"
  ) +
  scale_color_brewer(palette = "Dark2")

```



# adding the income bracket 

```{r}
get_url <- function(year) {
  if (year >= 2000 & year <= 2009) {
    # 2 digit folder + "current"
    two_digit <- sprintf("%02d", year %% 100)
    paste0("https://www.cdc.gov/asthma/brfss/", two_digit, "/current/tableC7.htm")

  } else if (year == 2010) {
    # 2010 only: has /current/
    "https://www.cdc.gov/asthma/brfss/2010/current/tableC7.htm"

  } else if (year >= 2011 & year <= 2020) {
    # 2011+ uses only year, NO 'current' folder
    paste0("https://www.cdc.gov/asthma/brfss/", year, "/tableC7.htm")

  } else {
    stop("Year outside supported range 2000–2020.")
  }
}

```

```{r}
library(rvest)
library(dplyr)
library(stringr)
library(purrr)
library(janitor)

scrape_income_table <- function(year) {
  
  url <- get_url(year)
  message("Scraping: ", url)
  
  page <- read_html(url)
  
  # Extract all HTML tables — usually the first is the income table
  tables <- page %>% html_table(fill = TRUE)
  
  # if table is missing, return empty df
  if (length(tables) == 0) return(data.frame())
  
  tbl <- tables[[1]] %>% clean_names()
  
  # Standardize column names (table structures vary slightly by year)
  names(tbl)[1:5] <- c("state", "income", "sample_size", "prevalence", "se")
  
  # Clean table
  tbl <- tbl %>%
    filter(
      !state %in% c("U.S. Total", "U.S. Total**", "", NA),
      !str_detect(state, "Total")   # removes "State Total"
    ) %>%
    mutate(
      year = year,
      prevalence = suppressWarnings(as.numeric(prevalence)),
      se = suppressWarnings(as.numeric(se))
    )
  
  return(tbl)
}

```

```{r}
years <- 2000:2020

income_data <- map_df(years, ~ tryCatch(scrape_income_table(.x), error = function(e) NULL))

glimpse(income_data)

```

#CLEANING THE DATA SET

```{r}
library(dplyr)
library(stringr)

income_clean <- income_data %>%
  # Keep the useful columns
  select(
    state,
    income,
    sample_size,
    prevalence,
    se,
    year
  ) %>%
  
  # Convert sample_size to numeric
  mutate(
    sample_size = str_replace_all(sample_size, ",", ""),
    sample_size = as.numeric(sample_size)
  ) %>%
  
  # Standardize income labels (optional)
  mutate(
    income = str_trim(income),
    income = case_when(
      income == "< $15,000" ~ "<15k",
      income == "$15-$24,999" ~ "15-25k",
      income == "$25-$49,999" ~ "25-50k",
      income == "$50-$74,999" ~ "50-75k",
      income == ">= $75,000" ~ "75k+",
      TRUE ~ income
    )
  ) %>%
  
  # Remove rows with missing prevalence (rare)
  filter(!is.na(prevalence))

glimpse(income_clean)
head(income_clean)


income_clean <- income_clean %>%
  mutate(
    state = state.name[match(state, state.abb)]
  )
head(unique(income_clean$state), 10)

```

#Encoding the income as an order parameter and merging all the data sets

```{r}
income_clean <- income_clean %>%
  mutate(
    income_factor = factor(
      income,
      levels = c("<15k", "15-25k", "25-50k", "50-75k", "75k+"),
      ordered = TRUE
    )
  )


full_merged <- income_clean %>%
  left_join(
    pollution_state_year,
    by = c("state", "year")
  )


income_pollution <- income_clean %>%
  left_join(pollution_state_year, by = c("state", "year"))


names(income_pollution)

```


#Centering pollutant variables

```{r}
poll_vars <- c("pm10_mean","o3_mean","no2_mean","so2_mean","co_mean")
poll_vars <- poll_vars[poll_vars %in% names(income_pollution)]
poll_vars


income_pollution <- income_pollution %>%
  mutate(
    across(
      all_of(poll_vars),
      ~ as.numeric(scale(.x, center = TRUE, scale = FALSE)),
      .names = "{.col}_c"
    )
  )

summary(income_pollution)

```

# Base fixed effect model

```{r}
library(plm)

model_base <- plm(
  prevalence ~ income_factor + o3_mean_c + no2_mean_c + so2_mean_c + co_mean_c,
  data  = income_pollution,
  index = c("state", "year"),
  model = "within"
)

summary(model_base)

```


```{r}
income_pollution$income_factor <- factor(income_pollution$income_factor, ordered = FALSE)

levels(income_pollution$income_factor)

income_pollution$income_factor <- relevel(income_pollution$income_factor, ref = "<15k")


library(plm)

model_income_dummies <- plm(
  prevalence ~ income_factor + o3_mean_c + no2_mean_c + so2_mean_c + co_mean_c,
  data  = income_pollution,
  index = c("state", "year"),
  model = "within"
)

summary(model_income_dummies)

```


```{r}
library(dplyr)
library(ggplot2)

income_summary <- income_pollution %>%
  filter(!is.na(income_factor)) %>%   # remove NA income levels
  group_by(income_factor) %>%
  summarise(
    mean_prev = mean(prevalence, na.rm = TRUE),
    se_prev   = sd(prevalence, na.rm = TRUE) / sqrt(n())
  )
ggplot(income_summary, aes(x = income_factor, y = mean_prev, fill = income_factor)) +
  geom_col(width = 0.6, color = "black", alpha = 0.8) +
  geom_errorbar(aes(ymin = mean_prev - se_prev, ymax = mean_prev + se_prev),
                width = 0.15, size = 0.9) +
  labs(
    title = "Mean Asthma Prevalence by Income Group",
    x = "Income Category",
    y = "Mean Asthma Prevalence (%)"
  ) +
  scale_fill_brewer(palette = "Blues") +
  theme_minimal(base_size = 14) +
  theme(legend.position = "none")

```



```{r}
linearHypothesis(
  model_income_dummies,
  c(
    "income_factor15-25k = 0",
    "income_factor25-50k = 0",
    "income_factor50-75k = 0"
  ),
  vcov. = vcovHC(model_income_dummies, type = "HC1")
)

```





This project investigates national asthma prevalence trends and their relationship with air pollution and socioeconomic factor mainly the income across all U.S. states from 2000-2020. Asthma prevalence data were scraped from CDC BRFSS tables, while pollutant concentration data (O_{3}, NO_{2}, SO_{2}, CO) and AQI metrics were derived from EPA pollution datasets from Kaggle. Income-stratified asthma data were also incorporated to examine disparities across economic groups. After extensive cleaning and merging, a unified state-year panel dataset was constructed to facilitate visualization, correlation analysis, regression modeling, and long-term trend estimation.

Visual exploration reveals substantial state-to-state variation in asthma rates and strong downward trends in key pollutants—particularly NO_{2}, SO_{2}, and CO. Regression analyses demonstrate statistically significant associations between asthma prevalence and certain pollutants (notably CO and SO_{2}), while fixed-effects modeling highlights persistent socioeconomic inequalities independent of pollution exposure. Trend comparison models show that declines in pollution do not necessarily coincide with improvements in asthma prevalence, underscoring asthma’s multifactorial nature. In sum, the project provides a comprehensive look at environmental and socioeconomic contributors to asthma and demonstrates how integrated datasets can be used to study population-level health outcomes.


Pollution has declined substantially, but asthma prevalence has not, indicating additional drivers beyond outdoor pollutants.

Geographic variability in asthma is pronounced and persistent.

Socioeconomic disparities are strong and consistent-low-income groups experience meaningfully higher asthma prevalence.

Pollutant-AQI correlations are extremely high, confirming dataset validity.

Regression and fixed-effects models identify statistically significant pollutant effects but explain only a modest portion of variation, especially compared to income.

# Model Fitting and Optimization

Let's take a look at the income bracket compared to asthma rate: 
```{r}
mean_pol <- pol_data %>%
  mutate(
    year = lubridate::year(date)
  ) %>%
  group_by(state, year) %>%
  summarise(
    annual_o3_mean = mean(o3_mean, na.rm = TRUE),
    annual_co_mean = mean(co_mean, na.rm=TRUE),
    annual_so2_mean = mean(so2_mean, na.rm=TRUE),
    annual_no2_mean = mean(no2_mean, na.rm=TRUE),
    .groups = 'drop'
  )

convert_state_code <- function(df, col = "State") {
  state_lookup <- setNames(state.name, toupper(state.abb))
  state_codes <- df[[col]]
  input_codes_upper <- toupper(as.character(state_codes))
  converted_names <- state_lookup[input_codes_upper]
  df[[col]] <- unname(converted_names)
  return(df)
}
asthma_data_clean <- convert_state_code(all_data, "state")

combined_data <- mean_pol %>%
  inner_join(asthma_data_clean, by = c("state", "year"))

head(combined_data)

combined_data %>% filter(state == "New York") %>%
  ggplot(aes(x = annual_o3_mean, y = prevalence)) + geom_point(
    aes(color = state), 
    alpha = 0.6 
  )

combined_data %>% filter(state == "New York") %>%
  ggplot(aes(x = annual_co_mean, y = prevalence)) + geom_point(
    aes(color = state), 
    alpha = 0.6 
  )

combined_data %>% filter(state == "New York") %>%
  ggplot(aes(x = annual_so2_mean, y = prevalence)) + geom_point(
    aes(color = state), 
    alpha = 0.6 
  )

combined_data %>% filter(state == "New York") %>%
  ggplot(aes(x = annual_no2_mean, y = prevalence)) + geom_point(
    aes(color = state), 
    alpha = 0.6 
  )

```

There seems to be a positive linear trend between annual o3 mean and asthma prevalnece in New York! Now, we can compare linear regression model fit for the most polluted states found earlier: 
```
 [1] "District Of Columbia" "Michigan"            
 [3] "New York"             "Arizona"             
 [5] "New Jersey"           "Indiana"             
 [7] "Colorado"             "Missouri"            
 [9] "Wisconsin"            "Illinois"  
```
 
```{r}
library(rsample)
# Test train split

keep = c("New York", "New Jersey", "Colorado", "Wisconsin", "Michigan", "Arizona", "Indiana", "Missouri", "Illinois")
subs <- combined_data[combined_data$state %in% keep, ]

data_split <- initial_split(
  subs, 
  prop = 0.75
)
train_data <- training(data_split)
test_data  <- testing(data_split)

# Train linear regression model
lm0 <- lm(prevalence ~ annual_o3_mean, data=train_data)

rmse <- function(actual, pred) {
  diff <- actual - pred
  return( sqrt(mean(diff^2)))
}

# Now test on data, calc RMSE to evaluate goodness of fit
rmse(test_data$prevalence, predict(lm0, test_data))
# lwk a really low value!

# Now, we want to minimize RMSE for a new model, consider a cube root function
mod <- function(a, b, data, x = "annual_o3_mean") {
  return (a + b * (data[[x]])^2 )
}

best <- optim(c(0, 0), function(a) rmse(train_data$prevalence, mod(a[1], a[2], train_data) ) ) 
best

best_fun <- function(x) {
  return (best$par[1] + best$par[2] * x^2)
}
  
ggplot(data=test_data, aes(x = annual_o3_mean, y = prevalence)) + geom_point(
    aes(color = state), 
    alpha = 0.6 
  ) + geom_function(fun = best_fun,
                    col = "#A8455D") + geom_abline(intercept=lm0$coefficients[1], slope=lm0$coefficients[2], col="#455AA8")


# taking factors code from above and adding ordering!
income_pollution$income_factor <- factor(income_pollution$income_factor, levels=c("<15k","15-25k", "25-50k", "50-75k"))
```

Okay,, we seem to be better than linear regression by a small amount. But perhaps we can do better with gradient descent: First, recall the function
```{r}
gradient_descent <- function(f, theta0, step_scale, stopping_deriv, max_iter, ...) {
  theta <- theta0
  for (i in 1:max_iter) {
    gradient <- numDeriv::grad(f, theta, ...)
    if(all(abs(gradient) < stopping_deriv)) {
      break()
    }
    theta <- theta - step_scale * gradient
  }
  if (i == max_iter) {
    warning("Maximal number of iterations reached, convergence not assured")
  }
  fit <- 
    list(
      argmin = theta,
      final_gradient = gradient,
      final_value = f(theta, ...),
      iterations = i,
      theta0 = theta0,
      step_scale = step_scale,
      stopping_deriv = stopping_deriv
      )
  return(fit)
}
```

Now, we apply gradient desscent with an objective function of RSME:
```{r}
adjusted_rmse <- function(b, Y, X) {
  return ( sqrt ( mean ( (Y - (b[1] * b[2]^X))^2)))
}
g <- gradient_descent(
  f = adjusted_rmse,
  theta0 = c(1,1),
  step_scale = 0.001,
  stopping_deriv=1e-4,
  max_iter = 20000,
  Y = train_data$prevalence,
  X = train_data$annual_o3_mean
)

grad_fun <- function(x) {
  return (g$argmin[1] * g$argmin[2]^x)
}
ggplot(data=test_data, aes(x = annual_o3_mean, y = prevalence)) + geom_point(
    aes(color = state), 
    alpha = 0.6 
  ) + geom_function(fun = grad_fun,
                    col = "#A8455D") + geom_abline(intercept=lm0$coefficients[1], slope=lm0$coefficients[2], col="#455AA8")
```



```{r}

set.seed(123)

income_coef_stat <- function(data, state_idx) {
  states <- unique(data$state)
  sampled_states <- states[state_idx]

  bstp <- bind_rows(
    lapply(sampled_states, function(s) {
      data[data$state == s, ]
    })
  )

  fit <- tryCatch(
    plm(
      prevalence ~ income_factor + o3_mean_c + no2_mean_c + so2_mean_c + co_mean_c,
      data  = bstp,
      index = c("state", "year"),
      model = "within"
    ),
    error = function(e) NULL
  )

  if (is.null(fit)) return(NA_real_)

  coef(fit)["income_factor25-50k"]
}

states <- unique(income_pollution$state)
n_states <- length(states)
M <- 1000

boot_dist <- numeric(M)

for (m in seq_len(M)) {
  bootstrap_state_idx <- sample(seq_len(n_states), replace = TRUE)
  boot_dist[m] <- income_coef_stat(income_pollution, bootstrap_state_idx)
}

boot_dist <- boot_dist[!is.na(boot_dist)]

alpha <- 0.05
bootstrap_CI <- quantile(boot_dist, c(alpha / 2, 1 - alpha / 2))

bootstrap_CI
sd(boot_dist)

ggplot(data.frame(x = boot_dist)) +
  geom_histogram(aes(x = x, y = after_stat(density)),
                 bins = 30,
                 fill = "steelblue",
                 color = "white") +
  geom_vline(
    xintercept = bootstrap_CI,
    color = "#455AA8",
    linewidth = 1.1
  ) +
  geom_vline(
    xintercept = coef(model_income_dummies)["income_factor25-50k"],
    color = "#A8455D",
    linewidth = 1.2
  ) +
  labs(
    title = "Bootstrap Distribution of Income Effect (25–50k vs <15k)",
    x = "Regression Coefficient",
    y = "Density"
  ) +
  theme_minimal(base_size = 14)


```
