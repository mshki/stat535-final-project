---
title: "STAT_535_Project"
author: "Sayak Chatterjee, Victoria Ip, Katherine Shi"
date: "Fall 2025"
output: pdf_document
---

## Imports

```{r}
library(rvest)
library(dplyr)
library(stringr)
library(purrr)
library(ggplot2)
library(readr)
library(janitor)
library(lubridate)
library(plm)
library(car)
library(broom)
library(tidyr)
library(rsample)
```

# Data Scraping

## Helper Functions

Helper function to convert state codes to the state name (to match asthma and pollutant data)
```{r}
convert_state_code <- function(df, col = "state") {
  state_lookup <- setNames(state.name, toupper(state.abb))
  dc_lookup <- setNames("District of Columbia", "DC")
  full_lookup <- c(state_lookup, dc_lookup)
  state_codes <- df[[col]]
  input_codes_upper <- toupper(as.character(state_codes))
  converted_names <- full_lookup[input_codes_upper]
  df[[col]] <- unname(converted_names)
  return(df)
}
```

## Asthma Rates Across States from 2000 - 2020

Hard coded URLs because of slight differences across years. Used table C1 from BRFSS for current asthma rates. 

```{r}
urls_c1 <- c(
  "2000" = "https://www.cdc.gov/asthma/brfss/00/current/tableC1.htm",
  "2001" = "https://www.cdc.gov/asthma/brfss/01/current/tableC1.htm",
  "2002" = "https://www.cdc.gov/asthma/brfss/02/current/tableC1.htm",
  "2003" = "https://www.cdc.gov/asthma/brfss/03/current/tableC1.htm",
  "2004" = "https://www.cdc.gov/asthma/brfss/04/current/tableC1.htm",
  "2005" = "https://www.cdc.gov/asthma/brfss/05/current/tableC1.htm",
  "2006" = "https://www.cdc.gov/asthma/brfss/06/current/tableC1.htm",
  "2007" = "https://www.cdc.gov/asthma/brfss/07/current/tableC1.htm",
  "2008" = "https://www.cdc.gov/asthma/brfss/08/current/tableC1.htm",
  "2009" = "https://www.cdc.gov/asthma/brfss/09/current/tableC1.htm",
  "2010" = "https://www.cdc.gov/asthma/brfss/2010/current/tableC1.htm",
  "2011" = "https://www.cdc.gov/asthma/brfss/2011/tableC1.htm",
  "2012" = "https://www.cdc.gov/asthma/brfss/2012/tableC1.htm",
  "2013" = "https://www.cdc.gov/asthma/brfss/2013/tableC1.htm",
  "2014" = "https://www.cdc.gov/asthma/brfss/2014/tableC1.htm",
  "2015" = "https://www.cdc.gov/asthma/brfss/2015/tableC1.htm",
  "2016" = "https://www.cdc.gov/asthma/brfss/2016/tableC1.htm",
  "2017" = "https://www.cdc.gov/asthma/brfss/2017/tableC1.htm",
  "2018" = "https://www.cdc.gov/asthma/brfss/2018/tableC1.html",
  "2019" = "https://www.cdc.gov/asthma/brfss/2019/tableC1.html",
  "2020" = "https://www.cdc.gov/asthma/brfss/2020/tableC1.html"
)

```

Function to scrape the webite. Note: Commmented out sanity check code. 

```{r}
scrape_c1 <- function(url, year) {
  # message("Scraping ", year, " from ", url)
  
  page <- try(read_html(url), silent = TRUE)
  # if (inherits(page, "try-error")) {
  #   warning("Failed to load ", url)
  #   return(NULL)
  # }
  
  # Extract all HTML tables
  tables <- page %>% html_table(fill = TRUE)
  # if (length(tables) == 0) {
  #   warning("No tables found for ", year)
  #   return(NULL)
  # }
  
  # Pick the table that contains "State" in headers
  idx <- which.max(
    sapply(tables, function(x) any(grepl("State", names(x), ignore.case = TRUE)))
  )
  
  df <- tables[[idx]]
  names(df) <- tolower(names(df))
  
  # Identify relevant columns
  state_col <- grep("state", names(df), value = TRUE)[1]
  prev_col  <- grep("prev|percent", names(df), value = TRUE)[1]
  se_col    <- grep("se|error", names(df), value = TRUE)[1]
  
  # if (is.na(state_col) || is.na(prev_col) || is.na(se_col)) {
  #   warning("Missing columns in ", year)
  #   return(NULL)
  # }
  
  # Clean the table
  df_clean <- df %>%
    select(state = !!state_col, prevalence = !!prev_col, se = !!se_col) %>%
    mutate(
      year = as.numeric(year),
      state = trimws(state),
      prevalence = as.numeric(gsub("[^0-9.]", "", prevalence)),
      se = as.numeric(gsub("[^0-9.]", "", se))
    ) %>%
    filter(!is.na(prevalence), !grepl("total", state, ignore.case = TRUE))
  
  return(convert_state_code(df_clean))
}

df_c1 <- map2_df(urls_c1, names(urls_c1), scrape_c1)
```

## Air Pollutants (Average) 2000-2024 - AQI and Mean

Read in data set downloaded from Kaggle, and then retrieve the average AQI and Mean across each year for each state. 

```{r}
pollutants <- read_csv("data/pollution_2000_2023.csv") %>% clean_names()

pollutants <- pollutants %>%
  mutate(date = suppressWarnings(as.Date(date, format = "%d/%m/%y")),
         year = year(date))

# Compute average pollutant AQI by state and year
mean_aqi <- pollutants %>% 
  group_by(state, year) %>%
  summarise(
    annual_o3_aqi = mean(o3_aqi, na.rm = TRUE),
    annual_co_aqi = mean(co_aqi, na.rm=TRUE),
    annual_so2_aqi = mean(so2_aqi, na.rm=TRUE),
    annual_no2_aqi = mean(no2_aqi, na.rm=TRUE),
    .groups = 'drop'
  )

# Compute average pollutant mean by state and year
mean_pol <- pollutants %>%
  group_by(state, year) %>%
  summarise(
    annual_o3_mean = mean(o3_mean, na.rm = TRUE),
    annual_co_mean = mean(co_mean, na.rm=TRUE),
    annual_so2_mean = mean(so2_mean, na.rm=TRUE),
    annual_no2_mean = mean(no2_mean, na.rm=TRUE),
    .groups = 'drop'
  )
```
## Combining the Data Sets


```{r}
combined_data <- mean_pol %>%
  inner_join(mean_aqi, by = c("state", "year")) %>%
  inner_join(df_c1, by = c("state", "year")) 
head(combined_data)
```

# Data Exploration

## Plotting Initial Observations

### Asthma Prevalence

```{r}
plot_asthma_year <- function(data, year_to_plot) {
  
  df_year <- data %>%
    filter(year == year_to_plot,
           !grepl("total", state, ignore.case = TRUE)) %>%
    mutate(state = trimws(state)) %>%
    arrange(prevalence)
  
  ggplot(df_year, aes(x = reorder(state, prevalence), y = prevalence)) +
    geom_col(fill = "steelblue", alpha = 0.85) +
    geom_errorbar(aes(ymin = prevalence - se,
                      ymax = prevalence + se),
                  width = 0.3, color = "black") +
    labs(
      title = paste("Asthma Prevalence by State in", year_to_plot),
      x = "State",
      y = "Asthma Prevalence (%)"
    ) +
    theme_minimal(base_size = 14) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
}
```

```{r}
plot_asthma_year(df_c1, 2000)
```

### Pollutant Means & AQI

Function to help plot:

```{r}
plot_pollutant_by_state <- function(data, year_to_plot, col) {
  
  df_year <- data %>%
    filter(year == year_to_plot) %>%
    select(state, year, all_of(col)) %>%
    arrange(.data[[col]])
  
  ggplot(df_year, aes(x = reorder(state, .data[[col]]), 
                      y = .data[[col]])) +
    geom_col(fill = "steelblue", alpha = 0.85) +
    labs(
      title = paste("State-wise", col, "in", year_to_plot),
      x = "State",
      y = paste("Mean", col)
    ) +
    theme_minimal(base_size = 14) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
}
```

First, we plot the annual means of the pollutants. 

```{r}
plot_pollutant_by_state(mean_pol, 2000, "annual_o3_mean")
plot_pollutant_by_state(mean_pol, 2000, "annual_no2_mean")
plot_pollutant_by_state(mean_pol, 2000, "annual_co_mean")
plot_pollutant_by_state(mean_pol, 2000, "annual_so2_mean")
```

Now, we plot the annual means of aqis of pollutants.

```{r}
plot_pollutant_by_state(mean_aqi, 2000, "annual_o3_aqi")
plot_pollutant_by_state(mean_aqi, 2000, "annual_co_aqi")
plot_pollutant_by_state(mean_aqi, 2000, "annual_so2_aqi")
plot_pollutant_by_state(mean_aqi, 2000, "annual_no2_aqi")
```

## Correlation Plots Between AQIs and Pollutants

```{r}
plot_correlation_aqi_pollutant <- function(aqi_data, pollutant_data, 
                                           year_to_plot, 
                                           aqi_col, pollutant_col) {
  
  # Merge AQI + pollutant dataset by state + year
  df <- aqi_data %>%
    inner_join(pollutant_data, by = c("state", "year")) %>%
    filter(year == year_to_plot) %>%
    select(state, year, all_of(aqi_col), all_of(pollutant_col))
  
  # Compute correlation
  corr_value <- round(cor(df[[aqi_col]], df[[pollutant_col]], use = "complete.obs"), 3)
  
  # Plot
  ggplot(df, aes(x = .data[[pollutant_col]], y = .data[[aqi_col]])) +
    geom_point(color = "steelblue", size = 3) +
    geom_smooth(method = "lm", se = TRUE, color = "red") +
    labs(
      title = paste("Correlation Between", pollutant_col, "and", aqi_col, "in", year_to_plot),
      subtitle = paste("Pearson r =", corr_value),
      x = paste("Mean", pollutant_col),
      y = paste("AQI:", aqi_col)
    ) +
    theme_minimal()
}

plot_correlation_aqi_pollutant(mean_aqi, mean_pol,
                               2018, "annual_no2_aqi", "annual_no2_mean")
plot_correlation_aqi_pollutant(mean_aqi, mean_pol,
                               2010, "annual_so2_aqi", "annual_so2_mean")
plot_correlation_aqi_pollutant(mean_aqi, mean_pol,
                               2000, "annual_o3_aqi", "annual_o3_mean")
plot_correlation_aqi_pollutant(mean_aqi, mean_pol,
                               2005, "annual_co_aqi", "annual_co_mean")
```


# Methods & Results
## Linear Regression

```{r}
# 1. Fixed-effects model
model_pollution_plm <- plm(
  prevalence ~ annual_o3_mean + annual_no2_mean + annual_so2_mean + annual_co_mean,
  data = combined_data,
  index = c("state","year"),
  model = "within"
)
summary(model_pollution_plm)

# 2. VIF using pooled OLS
model_pollution_pooled <- plm(
  prevalence ~ annual_o3_mean + annual_no2_mean + annual_so2_mean + annual_co_mean,
  data = combined_data,
  index = c("state","year"),
  model = "pooling"
)
vif(model_pollution_pooled)
```

## Using plm functionality for individual pollutants

```{r}
model_o3_plm <- plm(
  prevalence ~ annual_o3_mean,
  data = combined_data,
  index = c("state", "year"),
  model = "within"
)

summary(model_o3_plm)


model_co_plm <- plm(
  prevalence ~ annual_co_mean,
  data = combined_data,
  index = c("state", "year"),
  model = "within"
)

summary(model_co_plm)


model_so2_plm <- plm(
  prevalence ~ annual_so2_mean,
  data = combined_data,
  index = c("state", "year"),
  model = "within"
)

summary(model_so2_plm)


model_no2_plm <- plm(
  prevalence ~ annual_no2_mean,
  data = combined_data,
  index = c("state", "year"),
  model = "within"
)

summary(model_no2_plm)
```


## Pollution trends vs asthma trends

Compute Pollution and Asthma Trends for Each State

We will do this using per-state linear trends:

For each state, fit:

Pollutant (t) = $\alpha$ + $\beta$t
Asthma (t) = $\gamma$ + $\delta$t

Then compare the slopes $\beta$ and $\delta$ across states.

Which asks:
In states where pollution declined faster, did asthma prevalence also decline faster?

```{r}
o3_slopes <- combined_data %>%
  group_by(state) %>%
  do(tidy(lm(annual_o3_mean ~ year, data = .))) %>%
  filter(term == "year") %>%
  select(state, o3_slope = estimate)

no2_slopes <- combined_data %>%
  group_by(state) %>%
  do(tidy(lm(annual_no2_mean ~ year, data = .))) %>%
  filter(term == "year") %>%
  select(state, no2_slope = estimate)

so2_slopes <- combined_data %>%
  group_by(state) %>%
  do(tidy(lm(annual_so2_mean ~ year, data = .))) %>%
  filter(term == "year") %>%
  select(state, so2_slope = estimate)

co_slopes <- combined_data %>%
  group_by(state) %>%
  do(tidy(lm(annual_co_mean ~ year, data = .))) %>%
  filter(term == "year") %>%
  select(state, co_slope = estimate)
```

```{r}
asthma_slopes <- combined_data %>%
  group_by(state) %>%
  do(tidy(lm(prevalence ~ year, data = .))) %>%
  filter(term == "year") %>%
  select(state, asthma_slope = estimate)
```

```{r}
trend_data <- asthma_slopes %>%
  left_join(o3_slopes, by = "state") %>%
  left_join(no2_slopes, by = "state") %>%
  left_join(so2_slopes, by = "state") %>%
  left_join(co_slopes, by = "state")

trend_data
```

## Do states with faster pollution declines experience faster asthma declines?

```{r}
summary(lm(asthma_slope ~ o3_slope, data = trend_data))
summary(lm(asthma_slope ~ no2_slope, data = trend_data))
summary(lm(asthma_slope ~ so2_slope, data = trend_data))
summary(lm(asthma_slope ~ co_slope, data = trend_data))


ggplot(trend_data, aes(x = o3_slope, y = asthma_slope)) +
  geom_point(size = 3, color = "steelblue") +
  geom_smooth(method = "lm", se = TRUE, color = "red") +
  labs(
    title = "Do O3 Trends Predict Asthma Trends Over 2000–2020?",
    x = "Annual O3 Trend (slope)",
    y = "Annual Asthma Trend (slope)"
  ) +
  theme_minimal(base_size = 14)

ggplot(trend_data, aes(x = no2_slope, y = asthma_slope)) +
  geom_point(size = 3, color = "steelblue") +
  geom_smooth(method = "lm", se = TRUE, color = "red") +
  labs(
    title = "Do NO2 Trends Predict Asthma Trends Over 2000–2020?",
    x = "Annual NO2 Trend (slope)",
    y = "Annual Asthma Trend (slope)"
  ) +
  theme_minimal(base_size = 14)

ggplot(trend_data, aes(x = so2_slope, y = asthma_slope)) +
  geom_point(size = 3, color = "steelblue") +
  geom_smooth(method = "lm", se = TRUE, color = "red") +
  labs(
    title = "Do SO2 Trends Predict Asthma Trends Over 2000–2020?",
    x = "Annual SO2 Trend (slope)",
    y = "Annual Asthma Trend (slope)"
  ) +
  theme_minimal(base_size = 14)

ggplot(trend_data, aes(x = co_slope, y = asthma_slope)) +
  geom_point(size = 3, color = "steelblue") +
  geom_smooth(method = "lm", se = TRUE, color = "red") +
  labs(
    title = "Do CO Trends Predict Asthma Trends Over 2000–2020?",
    x = "Annual CO Trend (slope)",
    y = "Annual Asthma Trend (slope)"
  ) +
  theme_minimal(base_size = 14)
```


### Selecting 10 most polluted states

```{r}
# List of pollutant mean columns (modify as needed)
pollutants <- c("annual_o3_mean", "annual_no2_mean", "annual_so2_mean", "annual_co_mean")

# Compute average pollution across 2000–2020 for each state
state_pollution <- combined_data %>%
  group_by(state) %>%
  summarise(across(all_of(pollutants), mean, na.rm = TRUE)) %>%
  ungroup()

# Create a combined pollution index (average of standardized pollutants)
state_pollution <- state_pollution %>%
  mutate(pollution_index = rowMeans(scale(across(all_of(pollutants)))))
```

```{r}
top_states <- state_pollution %>%
  arrange(desc(pollution_index)) %>%
  slice(1:10) %>%
  pull(state)
top_states

highpoll_data <- combined_data %>%
  filter(state %in% top_states)
```

```{r}
model_highpoll <- plm(
  prevalence ~ annual_o3_mean + annual_no2_mean + annual_so2_mean + annual_co_mean,
  data = highpoll_data,
  index = c("state","year"),
  model = "within"
)

summary(model_highpoll)
```


```{r}
# convert dataset to long format for easy plotting
plot_data <- highpoll_data %>%
  select(state, year, prevalence, annual_o3_mean, annual_no2_mean, annual_so2_mean, annual_co_mean) %>%
  pivot_longer(cols = c(prevalence, annual_o3_mean, annual_no2_mean, annual_so2_mean, annual_co_mean),
               names_to = "variable", values_to = "value")

# facet plot for trends
ggplot(plot_data, aes(x = year, y = value, color = variable)) +
  geom_line(size = 1.1) +
  facet_wrap(~ state, scales = "free_y") +
  theme_bw() +
  labs(
    title = "Asthma & Pollution Trends in High-Pollution States",
    x = "Year",
    y = "Value",
    color = "Variable"
  ) +
  scale_color_brewer(palette = "Dark2")

```

## Analysis: Comparing 10 Most Pollutend States

```{r}
# Compute slopes for asthma for the 10 polluted states
asthma_slopes_high <- highpoll_data %>%
  group_by(state) %>%
  do(tidy(lm(prevalence ~ year, data = .))) %>%
  filter(term == "year") %>%
  select(state, asthma_slope = estimate)

# Compute pollution slopes for each pollutant
o3_slopes_high <- highpoll_data %>%
  group_by(state) %>%
  do(tidy(lm(annual_o3_mean ~ year, data = .))) %>%
  filter(term == "year") %>%
  select(state, o3_slope = estimate)

no2_slopes_high <- highpoll_data %>%
  group_by(state) %>%
  do(tidy(lm(annual_no2_mean ~ year, data = .))) %>%
  filter(term == "year") %>%
  select(state, no2_slope = estimate)

so2_slopes_high <- highpoll_data %>%
  group_by(state) %>%
  do(tidy(lm(annual_so2_mean ~ year, data = .))) %>%
  filter(term == "year") %>%
  select(state, so2_slope = estimate)

co_slopes_high <- highpoll_data %>%
  group_by(state) %>%
  do(tidy(lm(annual_co_mean ~ year, data = .))) %>%
  filter(term == "year") %>%
  select(state, co_slope = estimate)

# Final combined trend dataset
trend_high <- asthma_slopes_high %>%
  left_join(o3_slopes_high, by = "state") %>%
  left_join(no2_slopes_high, by = "state") %>%
  left_join(so2_slopes_high, by = "state") %>%
  left_join(co_slopes_high, by = "state")

trend_high

plot_trend_comparison <- function(data, pollutant_col, pollutant_label) {
  
  ggplot(data, aes_string(x = pollutant_col, 
                          y = "asthma_slope", 
                          color = "state")) +
    geom_point(size = 4, alpha = 0.9) +
    geom_smooth(method = "lm", se = TRUE, color = "black") +
    geom_text(aes(label = state),
              hjust = -0.1, vjust = -0.5, size = 2, show.legend = FALSE) +
    labs(
      title = paste("Asthma Trend vs", pollutant_label, "Trend (10 Most Polluted States)"),
      x = paste(pollutant_label, "Slope"),
      y = "Asthma Trend (Slope)"
    ) +
    theme_minimal(base_size = 14) +
    theme(
    legend.position = "none",
    plot.margin = margin(10, 10, 20, 20)
  )
  }


plot_trend_comparison(trend_high, "o3_slope",  "O3 Mean")
plot_trend_comparison(trend_high, "no2_slope", "NO2 Mean")
plot_trend_comparison(trend_high, "so2_slope", "SO2 Mean")
plot_trend_comparison(trend_high, "co_slope",  "CO Mean")

```





# Covariate Study

## Income Bracket

### Data Scraping 

Function to get urls for the current asthma prevalence for income brackets.

```{r}
get_c7_url <- function(year) {
  if (year >= 2000 & year <= 2009) {
    # 2 digit folder + "current"
    two_digit <- sprintf("%02d", year %% 100)
    paste0("https://www.cdc.gov/asthma/brfss/", two_digit, "/current/tableC7.htm")

  } else if (year == 2010) {
    # 2010 only: has /current/
    "https://www.cdc.gov/asthma/brfss/2010/current/tableC7.htm"

  } else if (year >= 2011 & year <= 2020) {
    # 2011+ uses only year, NO 'current' folder
    paste0("https://www.cdc.gov/asthma/brfss/", year, "/tableC7.htm")

  } else {
    stop("Year outside supported range 2000–2020.")
  }
}

```

Function to scrape income tables.

```{r}
scrape_c7 <- function(year) {
  
  url <- get_c7_url(year)
  # #message("Scraping: ", url)
  
  page <- read_html(url)
  
  # Extract all HTML tables — usually the first is the income table
  tables <- page %>% html_table(fill = TRUE)
  
  # if table is missing, return empty df
  if (length(tables) == 0) return(data.frame())
  
  tbl <- tables[[1]] %>% clean_names()
  
  # Standardize column names (table structures vary slightly by year)
  names(tbl)[1:5] <- c("state", "income", "sample_size", "prevalence", "se")
  
  # Clean table
  tbl <- tbl %>%
    filter(
      !state %in% c("U.S. Total", "U.S. Total**", "", NA),
      !str_detect(state, "Total")   # removes "State Total"
    ) %>%
    mutate(
      year = year,
      prevalence = suppressWarnings(as.numeric(prevalence)),
      se = suppressWarnings(as.numeric(se))
    )
  
  return(convert_state_code(tbl))
}

```

Now, to retrieve the asthma prevalence for income brackets for states for each year. 

```{r}
years <- 2000:2020

income_data <- map_df(years, ~ tryCatch(scrape_c7(.x), error = function(e) NULL))
```

### Data Cleaning

```{r}
income_clean <- income_data %>%
  # Keep the useful columns
  select(
    state,
    income,
    sample_size,
    prevalence,
    se,
    year
  ) %>%
  
  # Convert sample_size to numeric
  mutate(
    sample_size = str_replace_all(sample_size, ",", ""),
    sample_size = as.numeric(sample_size)
  ) %>%
  
  # Standardize income labels (optional)
  mutate(
    income = str_trim(income),
    income = case_when(
      income == "< $15,000" ~ "<15k",
      income == "$15-$24,999" ~ "15-25k",
      income == "$25-$49,999" ~ "25-50k",
      income == "$50-$74,999" ~ "50-75k",
      income == ">= $75,000" ~ "75k+",
      TRUE ~ income
    )
  ) %>%
  
  # Remove rows with missing prevalence (rare)
  filter(!is.na(prevalence))

```

#### Encoding the income as an order parameter and merging all the data sets

```{r}
income_clean <- income_clean %>%
  mutate(
    income_factor = factor(
      income,
      levels = c("<15k", "15-25k", "25-50k", "50-75k", "75k+"),
      ordered = TRUE
    )
  )

income_pollution <- income_clean %>%
  left_join(mean_pol, by = c("state", "year"))
```


#### Centering pollutant variables

```{r}
income_pollution <- income_pollution %>%
  mutate(
    across(
      all_of(pollutants),
      ~ as.numeric(scale(.x, center = TRUE, scale = FALSE)),
      .names = "{.col}_c"
    )
  )

summary(income_pollution)
```

### Base fixed effect model

```{r}
model_base <- plm(
  prevalence ~ income_factor + annual_o3_mean_c + annual_no2_mean_c + annual_so2_mean_c + annual_co_mean_c,
  data  = income_pollution,
  index = c("state", "year"),
  model = "within"
)

summary(model_base)

```


```{r}
income_pollution$income_factor <- factor(income_pollution$income_factor, ordered = FALSE)

levels(income_pollution$income_factor)

income_pollution$income_factor <- relevel(income_pollution$income_factor, ref = "<15k")

model_income_dummies <- plm(
  prevalence ~ income_factor + annual_o3_mean_c + annual_no2_mean_c + annual_so2_mean_c + annual_co_mean_c,
  data  = income_pollution,
  index = c("state", "year"),
  model = "within"
)

summary(model_income_dummies)

```


```{r}
income_summary <- income_pollution %>%
  filter(!is.na(income_factor)) %>%   # remove NA income levels
  group_by(income_factor) %>%
  summarise(
    mean_prev = mean(prevalence, na.rm = TRUE),
    se_prev   = sd(prevalence, na.rm = TRUE) / sqrt(n())
  )
ggplot(income_summary, aes(x = income_factor, y = mean_prev, fill = income_factor)) +
  geom_col(width = 0.6, color = "black", alpha = 0.8) +
  geom_errorbar(aes(ymin = mean_prev - se_prev, ymax = mean_prev + se_prev),
                width = 0.15, size = 0.9) +
  labs(
    title = "Mean Asthma Prevalence by Income Group",
    x = "Income Category",
    y = "Mean Asthma Prevalence (%)"
  ) +
  scale_fill_brewer(palette = "Blues") +
  theme_minimal(base_size = 14) +
  theme(legend.position = "none")

```



```{r}
linearHypothesis(
  model_income_dummies,
  c(
    "income_factor15-25k = 0",
    "income_factor25-50k = 0",
    "income_factor50-75k = 0"
  ),
  vcov. = vcovHC(model_income_dummies, type = "HC1")
)

```

### Model Fitting/Optimization - Coefficients
Let's take a look at the income bracket compared to asthma rate: 
```{r}
income_pollution %>%
  ggplot(aes(x = annual_o3_mean, y = prevalence)) + geom_point(
    aes(color = state), 
    alpha = 0.6 
  )

income_pollution %>%
  ggplot(aes(x = annual_co_mean, y = prevalence)) + geom_point(
    aes(color = state), 
    alpha = 0.6 
  )

income_pollution %>%
  ggplot(aes(x = annual_so2_mean, y = prevalence)) + geom_point(
    aes(color = state), 
    alpha = 0.6 
  )

income_pollution %>%
  ggplot(aes(x = annual_no2_mean, y = prevalence)) + geom_point(
    aes(color = state), 
    alpha = 0.6 
  )

```

There seems to be a positive linear trend between annual o3 mean and asthma prevalnece in New York! Now, we can compare linear regression model fit for the most polluted states found earlier: 
```
 [1] "District Of Columbia" "Michigan"            
 [3] "New York"             "Arizona"             
 [5] "New Jersey"           "Indiana"             
 [7] "Colorado"             "Missouri"            
 [9] "Wisconsin"            "Illinois"  
```
 
```{r}
keep = c("New York", "New Jersey", "Colorado", "Wisconsin", "Michigan", "Arizona", "Indiana", "Missouri", "Illinois")
subs <- combined_data[combined_data$state %in% keep, ]

# Train linear regression model
lm0 <- lm(prevalence ~ annual_o3_mean, data=subs)

rmse <- function(actual, pred) {
  diff <- actual - pred
  return( sqrt(mean(diff^2)))
}

# Now test on data, calc RMSE to evaluate goodness of fit
rmse(subs$prevalence, predict(lm0, subs))


# Now, we want to minimize RMSE for a new model, consider the following


mod <- function(a) {
  return (a[1] * (subs$annual_o3_mean)^a[2] )
}

best <- optim(c(0,0), function(a) rmse(subs$prevalence, mod(a))) 
best

best_fun <- function(x) {
  return (best$par[1] * x^(best$par[2]) )
}
  
ggplot(data=subs, aes(x = annual_o3_mean, y = prevalence)) + geom_point(
    aes(color = state), 
    alpha = 0.6 
  ) + geom_function(fun = best_fun,
                    col = "red") + geom_abline(intercept=lm0$coefficients[1], slope=lm0$coefficients[2], col="blue") + theme_minimal()
```

### Bootstrapping

```{r}
set.seed(123)
B <- 10000

# keep only rows with income category
tmp <- income_pollution %>% filter(!is.na(income_factor))

# bootstrap mean
boot_income_means <- tmp %>%
  group_by(income_factor) %>%
  summarise(
    boot_means = list(
      replicate(B, {
        boot_sample <- sample(prevalence, replace = TRUE)
        mean(boot_sample, na.rm = TRUE)
      })
    ),
    .groups = "drop"
  )


boot_income_means %>%
  rowwise() %>%
  mutate(
    lower95 = quantile(unlist(boot_means), 0.025),
    upper95 = quantile(unlist(boot_means), 0.975)
  )

plot_df <- boot_income_means %>%
  unnest_longer(boot_means) %>%
  mutate(income_factor = factor(income_factor))

ggplot(plot_df, aes(x = boot_means, fill = income_factor)) +
  geom_density(alpha = 0.4) +
  labs(
    title = "Bootstrap Distributions of Mean Asthma Prevalence by Income",
    x = "Bootstrapped Mean Asthma Prevalence",
    y = "Density",
    fill = "Income Group"
  ) +
  theme_minimal()


```
#### Specific brackets
```{r}
set.seed(123)

income_coef_stat <- function(data, state_idx) {
  states <- unique(data$state)
  sampled_states <- states[state_idx]

  bstp <- bind_rows(
    lapply(sampled_states, function(s) {
      data[data$state == s, ]
    })
  )

  fit <- tryCatch(
    plm(
      prevalence ~ income_factor + o3_mean_c + no2_mean_c + so2_mean_c + co_mean_c,
      data  = bstp,
      index = c("state", "year"),
      model = "within"
    ),
    error = function(e) NULL
  )

  if (is.null(fit)) return(NA_real_)

  coef(fit)["income_factor25-50k"]
}

states <- unique(income_pollution$state)
n_states <- length(states)
M <- 1000

boot_dist <- numeric(M)

for (m in seq_len(M)) {
  bootstrap_state_idx <- sample(seq_len(n_states), replace = TRUE)
  boot_dist[m] <- income_coef_stat(income_pollution, bootstrap_state_idx)
}

boot_dist <- boot_dist[!is.na(boot_dist)]

alpha <- 0.05
bootstrap_CI <- quantile(boot_dist, c(alpha / 2, 1 - alpha / 2))

bootstrap_CI
sd(boot_dist)

ggplot(data.frame(x = boot_dist)) +
  geom_histogram(aes(x = x, y = after_stat(density)),
                 bins = 30,
                 fill = "steelblue",
                 color = "white") +
  geom_vline(
    xintercept = bootstrap_CI,
    color = "#455AA8",
    linewidth = 1.1
  ) +
  geom_vline(
    xintercept = coef(model_income_dummies)["income_factor25-50k"],
    color = "#A8455D",
    linewidth = 1.2
  ) +
  labs(
    title = "Bootstrap Distribution of Income Effect (25–50k vs <15k)",
    x = "Regression Coefficient",
    y = "Density"
  ) +
  theme_minimal(base_size = 14)
```

## Age Group

First, get new urls.

```{r}
get_age_url <- function(year) {
  if (year >= 2000 & year <= 2009) {
    # 2 digit folder + "current"
    two_digit <- sprintf("%02d", year %% 100)
    paste0("https://www.cdc.gov/asthma/brfss/", two_digit, "/current/tableC3.htm")

  } else if (year == 2010) {
    # 2010 only: has /current/
    "https://www.cdc.gov/asthma/brfss/2010/current/tableC3.htm"

  } else if (year >= 2011 & year <= 2020) {
    # 2011+ uses only year, NO 'current' folder
    paste0("https://www.cdc.gov/asthma/brfss/", year, "/tableC3.htm")

  } else {
    stop("Year outside supported range 2000–2020.")
  }
}
```

Now, function for scraping age group tables

```{r}
scrape_age_group <- function(year) {
  
  url <- get_age_url(year)
  
  page <- read_html(url)
  
  # Extract all HTML tables — usually the first is the income table
  tables <- page %>% html_table(fill = TRUE)
  
  # if table is missing, return empty df
  if (length(tables) == 0) return(data.frame())
  
  tbl <- tables[[1]] %>% clean_names()
  
  # Standardize column names (table structures vary slightly by year)
  names(tbl)[1:5] <- c("state", "age_group", "sample_size", "prevalence", "se")
  
  # Clean table
  tbl <- tbl %>%
    filter(
      !state %in% c("U.S. Total", "U.S. Total**", "", NA),
      !str_detect(state, "Total")   # removes "State Total"
    ) %>% 
    mutate(
      year = year,
      prevalence = suppressWarnings(as.numeric(prevalence)),
      se = suppressWarnings(as.numeric(se))
    ) %>% 
    select(
      state,
      age_group,
      prevalence,
      se,
      year
    ) %>%  
    mutate(
      age_group = str_trim(age_group)
    ) %>% filter(!is.na(prevalence))

  return(convert_state_code(tbl, col="state"))
}
```

Now we get the data:
```{r}
age_data <- map_df(years, ~ tryCatch(scrape_age_group(.x), error = function(e) NULL))

glimpse(age_data)
```
Now, we (1) make levels, and (2) combine age group data set with mean pollution data set. 

```{r}
age_data <- age_data %>%
  mutate(
    age_group = factor(
      age_group,
      levels = c("18-24", "25-34", "35-44", "45-54", "55-64", "65+"),
      ordered = TRUE
    )
  )

combined_pol_and_age <- mean_pol %>%
  inner_join(age_data, by = c("state", "year"))
```

We can create scatterplots to demonstrate the relationship in most prevalent states:
```{r}
keep = c("New York", "New Jersey", "Colorado", "Wisconsin", "Michigan", "Arizona", "Indiana", "Missouri", "Illinois")
subs_age <- combined_pol_and_age[combined_pol_and_age$state %in% keep, ]

subs_age %>%
  ggplot(aes(x = annual_co_mean, y = prevalence)) + geom_point(
    aes(color = age_group), 
    alpha = 0.85
  ) + theme_minimal()
subs_age %>%
  ggplot(aes(x = annual_o3_mean, y = prevalence)) + geom_point(
    aes(color = age_group), 
    alpha = 0.85
  ) + theme_minimal()
subs_age %>%
  ggplot(aes(x = annual_so2_mean, y = prevalence)) + geom_point(
    aes(color = age_group), 
    alpha = 0.85
  ) + theme_minimal()
subs_age %>%
  ggplot(aes(x = annual_no2_mean, y = prevalence)) + geom_point(
    aes(color = age_group), 
    alpha = 0.85
  ) + theme_minimal()
```

Now, we create model
```{r}
agelm <- plm(
  prevalence ~ age_group + annual_o3_mean + annual_no2_mean + annual_so2_mean + annual_co_mean,
  data  = combined_pol_and_age,
  index = c("state", "year"),
  model = "within"
)

summary(agelm)
```

Now, we can find:
```{r}
age_summary <- age_data %>%
  filter(!is.na(age_group)) %>%   # remove NA income levels
  group_by(age_group) %>%
  summarise(
    mean_prev = mean(prevalence, na.rm = TRUE),
    se_prev   = sd(prevalence, na.rm = TRUE) / sqrt(n())
  )

ggplot(age_summary, aes(x = age_group, y = mean_prev, fill = age_group)) +
  geom_col(width = 0.6, color = "black", alpha = 0.8) +
  geom_errorbar(aes(ymin = mean_prev - se_prev, ymax = mean_prev + se_prev),
                width = 0.15, size = 0.9) +
  labs(
    title = "Mean Asthma Prevalence by Age Group",
    x = "Age Group",
    y = "Mean Asthma Prevalence (%)"
  ) +
  scale_fill_brewer(palette = "Blues") +
  theme_minimal(base_size = 14) +
  theme(legend.position = "none")
```

